<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title></title>
    <script type="text/javascript" src="../src/js/eDebugger.js"></script>
    <script type="text/javascript" src="../src/js/json2.js"></script>
    <script type="text/javascript" src="../src/js/Evoque.js"></script>
    <script type="text/javascript" src="../src/js/Evoque.Dialog.js"></script>
    <script type="text/javascript" src="../src/js/Evoque.Ajax.js"></script>
    <link rel="stylesheet" type="text/css" href="../src/style/Evoque.Dialog.css" />
    <script type="text/javascript">
        var maxWidth = 800;
        var maxHeight = 600;

        function uploadFile()
        {
            /*var files = $('#fileSelect')[0].files;
            var parameter = {};
            for (var i = 0; i < files.length; ++i)
            {
                parameter['file_' + i] = files[i];
            }
            $.ajax.post({
                url : '/Upload/Index',
                // json
                parameter : parameter,
                // 'text'(default), 'json', 'html'
                returnType : 'json',
                onSuccess : function (returnObj) {
                    $.dialog.alert('Upload Success!');
                },
                onFail : function () {
                    $.dialog.alert('Upload failed!');
                }
            });*/
            var file = $('#fileSelect')[0].files[0];

            var reader = new FileReader();
            reader.onload = function (e) {
                var img = new Image();
                img.onload = function (e) {
                    var w = e.target.width;
                    var h = e.target.height;
                    var ww = w, hh = h;
                    if (w > maxWidth)
                    {
                        ww = maxWidth;
                        hh = ww * h / w;
                        if (hh > maxHeight)
                        {
                            hh = maxHeight;
                            ww = hh * w / h;
                        }
                    }
                    else
                    {
                        if (h > maxHeight)
                        {
                            hh = maxHeight;
                            ww = hh * w / h;
                        }
                        else
                        {
                            ww = w;
                            hh = h;
                        }
                    }
                    ww = Math.round(ww);
                    hh = Math.round(hh);
                    e.target.style.width = ww + 'px';
                    e.target.style.height = hh + 'px';

                    var cvs = $('#imgUp')[0];
                    cvs.width = maxWidth;
                    cvs.height = maxHeight;
                    var ctx = cvs.getContext("2d");
                    // canvas清屏
                    ctx.clearRect(0, 0, cvs.width, cvs.height);
                    ctx.strokeStyle = 'red';
                    ctx.strokeRect(0, 0, maxWidth, maxHeight);
                    var x = 0, y = 0;
                    if (ww < maxWidth)
                    {
                        x = (maxWidth - ww) / 2;
                    }
                    if (hh < maxHeight)
                    {
                        y = (maxHeight - hh) / 2;
                    }
                    alert(ww / w);
                    alert(hh / h);
                    ctx.scale(ww / w, 1);
                    ctx.drawImage(e.target, x, Math.round(y * h / hh));

                    var imgData =cvs.toDataURL("image/jpeg", 0.5);
                    $('#ret').setStyle('width', '300px');
                    $('#ret').setStyle('height', '400px');
                    $('#ret')[0].src = imgData;

                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(file);
        }
    </script>
</head>
<body>
    <p><input id="fileSelect" type="file" accept="image/*" multiple="multiple"></p>
    <p>
        <input id="upload" type="button" value="上传" onclick="uploadFile()">
        <progress id="uploadprogress" min="0" max="100" value="0">0</progress>
    </p>
    <p>
        <canvas id="imgUp"></canvas>
    </p>
    <img id="ret">
</body>
</html>